{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}
    注册-租好物
{% endblock %}

{% block load_css %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/gritter/css/jquery.gritter.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row ptb-20">
            <label class="col-lg-6 col-md-12 ml-auto mr-auto">
                <label class="register-form-container">
                    <h2 class="register-heading"> 注册 </h2>
                    <form id="register_form">
                        {% csrf_token %}
                        {{ form.username }}
                        {{ form.password }}
                        {{ form.password2 }}
                        {{ form.mobile }}
                        <label>
                            {{ form.mobile_captcha }}
                            {# 给发送短信按钮添加动作 #}
                            <input onclick="sendmessage(this,60);" type="button" value="获取短信验证码"
                                   class="captcha-btn pull-right">
                        </label>
                        <div class="button-box">
                            <button class="btn-block" style="height:50px;" type="button" id="register_btn">注册</button>
                            <span style="line-height: 2;"> 已有帐号，
                                <a href="{% url 'accounts:login' %}" style="float: none;"> 请登录 </a>
                            </span>
                        </div>
                    </form>
                </label>
            </label>
        </div>
    </div>

{% endblock %}

{% block load_js %}
    {# 加载提示工具对应的js #}
    <script type="text/javascript" src="{% static 'assets/gritter/js/jquery.gritter.js' %}"></script>
    <script>
        //点击发送短信验证码后验证手机号
        function sendmessage(obj, second) {
            var telRegex = /(13|14|15|17|18)\d{9}/;
            if (telRegex.test($.trim($("#id_mobile").val()))) {
                $.ajax({
                    url: "{% url 'apis:get_mobile_captcha' %}",
                    type: "GET",
                    dataType: "json",
                    data: {"mobile": $("#id_mobile").val()},
                    success: function (data) {
                        $.gritter.add({
                            // (string | mandatory) the heading of the notification
                            title: '提交结果',
                            // (string | mandatory) the text inside the notification
                            //text: 'This will fade out after a certain amount of time. Vivamus eget tincidunt velit. Cum sociis natoque penatibus et <a href="#" style="color:#ccc">magnis dis parturient</a> montes, nascetur ridiculus mus.'
                            text: data.msg
                            // 关闭时效果
                            // sticky: true,
                            // 关闭时的淡化效果时间
                            // time: '3000',
                            // 定制显示样式的类名
                            // class_name: ''
                        });
                    }
                });
                countDown(obj, second)
            } else {
                $.gritter.add({
                    // (string | mandatory) the heading of the notification
                    title: '提交结果',
                    // (string | mandatory) the text inside the notification
                    //text: 'This will fade out after a certain amount of time. Vivamus eget tincidunt velit. Cum sociis natoque penatibus et <a href="#" style="color:#ccc">magnis dis parturient</a> montes, nascetur ridiculus mus.'
                    text: '手机号有误'
                });
            }
        }

        //重新发送倒计时
        function countDown(obj, second) {
            // 如果秒数还是大于0，则表示倒计时还没结束
            if (second >= 0) {
                // 获取默认按钮上的文字
                if (typeof buttonDefaultValue === 'undefined') {
                    buttonDefaultValue = obj.defaultValue;
                }
                // 按钮置为不可点击状态
                obj.disabled = true;
                // 按钮里的内容呈现倒计时状态
                obj.value = buttonDefaultValue + '(' + second + ')';
                // 时间减一
                second--;
                // 一秒后重复执行
                setTimeout(function () {
                    countDown(obj, second);
                }, 1000);
                // 否则，按钮重置为初始状态
            } else {
                // 按钮置未可点击状态
                obj.disabled = false;
                // 按钮里的内容恢复初始状态
                obj.value = buttonDefaultValue;
            }
        }

        //动态检测验证码
        $("#register_btn").click(function () {
            // some_check
            $.ajax({
                    url: "{% url 'accounts:register' %}", //{"username":"cali"}
                    type: "POST",
                    dataType: "json",
                    data: $("#register_form").serialize(),
                    success: function (data) {
                        if (data.status == 200) {
                            window.location.href = "{% url 'index2' %}";
                        } else {
                            msg = "新错误类型"
                            if (data.status == 400 || data.status == 401) {
                                msg = data.msg
                            } else {
                                //402 => form.errors
                                for (var i in data.msg) {
                                    msg = i + data.msg[i]
                                    break
                                }
                            }
                            $.gritter.add({
                                // (string | mandatory) the heading of the notification
                                title: '提交结果',
                                // (string | mandatory) the text inside the notification
                                //text: 'This will fade out after a certain amount of time. Vivamus eget tincidunt velit. Cum sociis natoque penatibus et <a href="#" style="color:#ccc">magnis dis parturient</a> montes, nascetur ridiculus mus.'
                                text: msg
                            });
                        }
                    },
                    // 解决csrftoken
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                    }
                }
            );
        });
    </script>
{% endblock %}

